<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Constellation Interactive ‚Äî Maquette (1-fichier)</title>
  <style>
    :root{
      --bg-1:#0a0a0c; --bg-2:#0b1020; --bg-3:#111827;
      --panel:#111214; --muted:#9aa4b2; --accent:#7dd3fc; --text:#e5e7eb;
      --ring:#94a3b8; --card:#0d0f14; --shadow:0 8px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; color:var(--text); font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; background:radial-gradient(1200px 600px at 20% -10%, #112, transparent), radial-gradient(900px 500px at 80% 110%, #021, transparent), linear-gradient(var(--bg-1), var(--bg-2) 60%, var(--bg-3));}

    .app{display:grid; grid-template-columns:1fr 340px; gap:16px; padding:16px; height:100%;}
    @media (max-width: 960px){.app{grid-template-columns:1fr;}}

    .card{background:var(--card); border:1px solid #141820; border-radius:16px; box-shadow:var(--shadow); overflow:hidden}
    .toolbar{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #151a23; background:linear-gradient(#0b0e14, #0b0f16)}
    .title{display:flex; gap:8px; align-items:center; font-weight:600}

    .btn{appearance:none; border:1px solid #202532; background:#0f1320; color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; display:inline-flex; align-items:center; gap:6px}
    .btn:hover{border-color:#2a3142; background:#12182a}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#0e131e}
    .btn.ghost{background:transparent; border-color:#1a2030}

    .toolbar .actions{display:flex; gap:8px; flex-wrap:wrap}
    .canvas-wrap{position:relative; height:calc(100vh - 160px); min-height:360px}
    @media (max-width: 960px){.canvas-wrap{height:54vh}}
    canvas{display:block; width:100%; height:100%; cursor:crosshair}

    .hud{position:absolute; left:12px; top:12px; background:rgba(0,0,0,.45); color:#fff; font-size:12px; padding:6px 8px; border-radius:8px; pointer-events:none}

    .panel{background:var(--panel); border:1px solid #141820; border-radius:16px; padding:12px; box-shadow:var(--shadow); overflow:auto;}
    .group{padding:12px; border:1px solid #171c27; border-radius:12px; background:#0d1018; margin-bottom:12px}
    .group h3{margin:0 0 8px 0; font-size:13px; color:#c7d2fe}
    .row{display:flex; align-items:center; justify-content:space-between; gap:8px; margin:10px 0}
    .row label{color:var(--muted); font-size:12px}

    input[type="range"]{width:100%}
    input[type="text"], input[type="number"], select{width:100%; padding:8px 10px; border-radius:10px; border:1px solid #1a2130; background:#0b0f18; color:var(--text)}
    input[type="checkbox"]{transform:scale(1.1)}

    .footer-note{font-size:12px; color:var(--muted)}
    .roadmap{font-size:13px; color:var(--muted); padding-left:18px}
    .roadmap li{margin:6px 0}

    .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#0b1324; border:1px solid #172036; font-size:12px; color:#d1d5db}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0b0f18; border:1px solid #1a2130; padding:2px 6px; border-radius:6px; font-size:12px}
  </style>
</head>
<body>
  <main class="app">
    <!-- Carte Canvas -->
    <section class="card">
      <div class="toolbar">
        <div class="title">‚ú® Constellation Interactive ‚Äî Maquette</div>
        <div class="actions">
          <button id="btn-full" class="btn ghost" title="Plein √©cran">‚õ∂ Plein √©cran</button>
          <button id="btn-rand" class="btn secondary" title="Nouvelle graine">üîÑ Alea</button>
          <button id="btn-export" class="btn" title="Exporter PNG">üíæ Export PNG</button>
        </div>
      </div>
      <div class="canvas-wrap" id="canvas-wrap">
        <canvas id="sky"></canvas>
        <div class="hud">Glisser une √©toile ‚Ä¢ Survol = halo ‚Ä¢ Export PNG ‚Ä¢ <span class="kbd">E</span> suppression segments ‚Ä¢ <span class="kbd">G</span> gravit√©</div>
      </div>
    </section>

    <!-- Panneau de contr√¥les -->
    <aside class="panel">
      <div class="group">
        <h3>Param√®tres</h3>

        <div class="row">
          <label>Palette th√©matique</label>
        </div>
        <select id="sel-palette">
          <option value="nocturne" selected>Nocturne (bleu)</option>
          <option value="aurore">Aurore (rose-violet)</option>
          <option value="nebuleuse">N√©buleuse (teal)</option>
          <option value="crepuscule">Cr√©puscule (dor√©)</option>
        </select>

        <div class="row" style="margin-top:10px">
          <label>D√©grad√© de fond (3 couleurs)</label>
        </div>
        <input id="inp-grad" type="text" value="#09090b,#0b1020,#111827" />

        <div class="row" style="margin-top:14px">
          <label>Nombre d'√©toiles: <span id="lab-count">120</span></label>
        </div>
        <input id="inp-count" type="range" min="20" max="400" step="1" value="120" />

        <div class="row" style="margin-top:14px">
          <label>Distance de connexion: <span id="lab-dist">120</span> px</label>
        </div>
        <input id="inp-dist" type="range" min="40" max="240" step="1" value="120" />

        <div class="row" style="margin-top:10px">
          <label>Gravit√©: <span id="lab-grav">0</span></label>
        </div>
        <input id="inp-grav" type="range" min="0" max="100" step="1" value="0" />

        <div class="row" style="margin-top:10px">
          <label class="pill"><input id="chk-anim" type="checkbox" checked /> Animation</label>
          <label class="pill"><input id="chk-twink" type="checkbox" checked /> Scintillement</label>
          <label class="pill"><input id="chk-labels" type="checkbox" /> Labels</label>
          <label class="pill"><input id="chk-erase" type="checkbox" /> Suppression de segments</label>
        </div>

        <div class="row" style="margin-top:10px; gap:10px">
          <button id="btn-toggle" class="btn secondary" style="flex:1">‚è∏Ô∏è Pause</button>
          <button id="btn-reset" class="btn ghost" style="flex:1">‚ú¶ Reset</button>
          <button id="btn-clear-blocked" class="btn ghost" style="flex:1">‚Ü∫ R√©init. segments</button>
        </div>
      </div>

      <div class="group">
        <h3>Infos</h3>
        <div class="row"><label>Seed: <span id="lab-seed">42</span></label></div>
        <p class="footer-note">O(n¬≤) pour les connexions (ok maquette). PNG & plein √©cran inclus.</p>
      </div>

      <div class="group">
        <h3>Roadmap</h3>
        <ul class="roadmap">
          <li>Palettes th√©matiques ‚úÖ</li>
          <li>Mode gravit√© (attraction douce) ‚úÖ</li>
          <li>Suppression de segments ‚úÖ</li>
          <li>Prochaines id√©es: dessin de segments, export SVG, presets partag√©s‚Ä¶</li>
        </ul>
      </div>
    </aside>
  </main>

  <script>
  (function(){
    'use strict';
    // ---------- √âTAT ----------
    let seed = 42 >>> 0;
    let count = 120;
    let connectDist = 120;
    let twinkle = true;
    let animate = true;
    let showLabels = false;

    // Palettes & gravit√©
    const palettes = {
      nocturne:  { grad:"#09090b,#0b1020,#111827", hue:[205,245] },   // bleu-cyan
      aurore:    { grad:"#0b0915,#2a1037,#461a52", hue:[315,355] },   // rose-magenta
      nebuleuse: { grad:"#031e1e,#0a2630,#10384a", hue:[170,200] },   // teal-vert
      crepuscule:{ grad:"#130f08,#261514,#3a1e1b", hue:[25,45] }      // dor√©
    };
    let currentPalette = 'nocturne';

    let gravity = 0;          // 0..1
    let lastGravity = 0.5;    // m√©morise la derni√®re valeur non-nulle pour le toggle
    const GRAV_COEFF = 0.002; // intensit√© (accord√©e pour dt en ms)

    // Suppression de segments
    const blockedLinks = new Set(); // "a-b"
    let eraseMode = false;
    let segments = [];
    let hoverSeg = null;

    const wrap = document.getElementById('canvas-wrap');
    const canvas = document.getElementById('sky');
    const ctx = canvas.getContext('2d', { alpha:false });
    let dpr = 1;
    let stars = [];
    let hoverId = null;
    let draggingId = null;

    // ---------- UTIL ----------
    function makeRand(s){
      s >>>= 0;
      return function(){
        s = (s * 1664525 + 1013904223) >>> 0;
        return s / 4294967296;
      };
    }
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
    function parseGradient(str){
      const parts = (str||'').split(',').map(s=>s.trim()).filter(Boolean);
      const c1 = parts[0] || '#09090b';
      const c2 = parts[1] || '#0b1020';
      const c3 = parts[2] || '#111827';
      return [c1,c2,c3];
    }
    function keyPair(a,b){ return (a<b) ? a+'-'+b : b+'-'+a; }

    // point -> segment
    function distPointToSegment(px,py, x1,y1, x2,y2){
      const dx = x2-x1, dy = y2-y1;
      const len2 = dx*dx + dy*dy;
      if (len2 === 0) return {dist: Math.hypot(px-x1,py-y1), t:0};
      let t = ((px-x1)*dx + (py-y1)*dy) / len2;
      t = Math.max(0, Math.min(1, t));
      const nx = x1 + t*dx, ny = y1 + t*dy;
      return {dist: Math.hypot(px-nx, py-ny), t};
    }
    function pickSegment(px,py, tol=10){
      let best = tol, found = null;
      for (const seg of segments){
        const {dist} = distPointToSegment(px,py, seg.ax,seg.ay, seg.bx,seg.by);
        if (dist < best){ best = dist; found = seg; }
      }
      return found;
    }

    // ---------- G√âN√âRATION ----------
    function regenStars(){
      const rand = makeRand(seed);
      stars = new Array(count).fill(0).map((_,i)=>{
        const x = rand();
        const y = rand();
        const speed = 0.12 + rand()*0.28;
        const ang = rand() * Math.PI * 2;
        return {
          id:i,
          x, y,
          vx: Math.cos(ang) * speed * 0.001,
          vy: Math.sin(ang) * speed * 0.001,
          c: rand(),                  // graine couleur 0..1 (pour palette)
          size: 1 + rand() * 2.2
        };
      });
      blockedLinks.clear(); // nouvelle seed ou count ‚Üí on r√©initialise les suppressions
      document.getElementById('lab-seed').textContent = String(seed);
    }

    // ---------- DIMENSIONS ----------
    function resize(){
      const rect = wrap.getBoundingClientRect();
      const w = Math.max(320, Math.floor(rect.width));
      const h = Math.max(260, Math.floor(rect.height));
      dpr = Math.max(1, window.devicePixelRatio || 1);
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    new ResizeObserver(resize).observe(wrap);

    // ---------- DESSIN ----------
    function draw(dt){
      const w = canvas.clientWidth;
      const h = canvas.clientHeight;

      // arri√®re-plan depuis la palette / input
      const custom = document.getElementById('inp-grad').value;
      const [c1,c2,c3] = parseGradient(custom);
      const g = ctx.createLinearGradient(0,0,0,h);
      g.addColorStop(0, c1); g.addColorStop(0.6, c2); g.addColorStop(1, c3);
      ctx.fillStyle = g; ctx.fillRect(0,0,w,h);

      // animation + gravit√© douce vers le centre (0.5,0.5)
      if (animate){
        for (let s of stars){
          if (gravity > 0){
            const ax = (0.5 - s.x) * (gravity * GRAV_COEFF) * dt;
            const ay = (0.5 - s.y) * (gravity * GRAV_COEFF) * dt;
            s.vx += ax; s.vy += ay;
            const damp = 0.0006 * dt; // amortissement l√©ger
            s.vx *= (1 - damp); s.vy *= (1 - damp);
          }
          s.x += s.vx * dt; s.y += s.vy * dt;
          if (s.x < 0 || s.x > 1) s.vx *= -1;
          if (s.y < 0 || s.y > 1) s.vy *= -1;
          s.x = clamp(s.x,0,1); s.y = clamp(s.y,0,1);
        }
      }

      // Connexions O(n^2) (en respectant les segments supprim√©s)
      ctx.lineWidth = 1;
      segments = [];
      for (let i=0;i<stars.length;i++){
        const a = stars[i]; const ax = a.x * w, ay = a.y * h;
        for (let j=i+1;j<stars.length;j++){
          const b = stars[j]; const bx = b.x * w, by = b.y * h;
          const dx = bx-ax, dy = by-ay; const d = Math.hypot(dx,dy);
          if (d < connectDist){
            const key = keyPair(i,j);
            if (blockedLinks.has(key)) continue;
            const alpha = 1 - d / connectDist;
            ctx.strokeStyle = 'rgba(180,200,255,' + (alpha*0.6) + ')';
            ctx.beginPath(); ctx.moveTo(ax,ay); ctx.lineTo(bx,by); ctx.stroke();
            segments.push({a:i,b:j, ax,ay,bx,by});
          }
        }
      }

      // √©toiles (teinte mapp√©e selon la palette)
      const t = performance.now();
      const [h0,h1] = palettes[currentPalette].hue;
      const dh = (h1 - h0);
      for (let s of stars){
        const hue = h0 + dh * s.c;
        const px = s.x * w, py = s.y * h;
        const tw = twinkle ? (0.6 + Math.sin((px + py + t*0.003)) * 0.4) : 1;
        const r = Math.max(1.2, s.size * tw);
        const grad = ctx.createRadialGradient(px,py,0, px,py,r*3);
        grad.addColorStop(0, `hsla(${hue},100%,85%,0.9)`);
        grad.addColorStop(1, `hsla(${hue},100%,50%,0)`);
        ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(px,py,r*3,0,Math.PI*2); ctx.fill();
        ctx.fillStyle = `hsl(${hue},100%,95%)`; ctx.beginPath(); ctx.arc(px,py,r,0,Math.PI*2); ctx.fill();
        if (showLabels){ ctx.fillStyle='rgba(255,255,255,.85)'; ctx.font='12px system-ui'; ctx.fillText('‚òÖ '+s.id, px+6, py-6); }
        if (hoverId === s.id){ ctx.strokeStyle='rgba(255,255,255,.8)'; ctx.lineWidth=1.5; ctx.beginPath(); ctx.arc(px,py,(r+6)*1.6,0,Math.PI*2); ctx.stroke(); }
      }

      // surbrillance du segment cibl√© en mode suppression
      if (eraseMode && hoverSeg){
        ctx.strokeStyle = 'rgba(255,255,255,0.9)';
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(hoverSeg.ax, hoverSeg.ay); ctx.lineTo(hoverSeg.bx, hoverSeg.by); ctx.stroke();
      }
    }

    // ---------- BOUCLE ----------
    let raf = 0, last = performance.now();
    function loop(ts){
      const dt = clamp(ts - last, 0, 32); last = ts;
      draw(dt);
      raf = requestAnimationFrame(loop);
    }

    // ---------- INTERACTIONS ----------
    function pickStar(px,py){
      let bestId=null, best=1e9; const w = canvas.clientWidth, h = canvas.clientHeight;
      for (const s of stars){
        const dx = px - s.x*w, dy = py - s.y*h; const d2 = dx*dx + dy*dy; if (d2<best){best=d2; bestId=s.id;}
      }
      return Math.sqrt(best) < 24 ? bestId : null;
    }
    function pickSegmentAt(x,y){ return pickSegment(x,y, 10); }

    canvas.addEventListener('pointermove', (e)=>{
      const r = canvas.getBoundingClientRect(); const x = e.clientX - r.left; const y = e.clientY - r.top;
      if (eraseMode){ hoverSeg = pickSegmentAt(x,y); return; }
      if (draggingId!=null){
        const s = stars[draggingId]; if (s){ s.x = clamp(x / canvas.clientWidth,0,1); s.y = clamp(y / canvas.clientHeight,0,1); }
      } else { hoverId = pickStar(x,y); }
    });

    canvas.addEventListener('pointerdown', (e)=>{
      const r = canvas.getBoundingClientRect(); const x = e.clientX - r.left; const y = e.clientY - r.top;
      if (eraseMode){
        const seg = pickSegmentAt(x,y);
        if (seg){ blockedLinks.add(keyPair(seg.a, seg.b)); hoverSeg = null; return; }
      }
      canvas.setPointerCapture(e.pointerId);
      const id = pickStar(x,y);
      if (id!=null) draggingId = id;
    });
    canvas.addEventListener('pointerup', (e)=>{ draggingId = null; canvas.releasePointerCapture?.(e.pointerId); });

    // ---------- CONTR√îLES UI ----------
    const byId = (id)=>document.getElementById(id);
    const inpCount = byId('inp-count'); const labCount = byId('lab-count');
    const inpDist = byId('inp-dist'); const labDist = byId('lab-dist');
    const inpGrad = byId('inp-grad');
    const selPalette = byId('sel-palette');
    const chkAnim = byId('chk-anim'); const chkTwink = byId('chk-twink'); const chkLabels = byId('chk-labels');
    const chkErase = byId('chk-erase');
    const btnClearBlocked = byId('btn-clear-blocked');
    const inpGrav = byId('inp-grav'); const labGrav = byId('lab-grav');

    // sliders / inputs
    inpCount.addEventListener('input', ()=>{ count = +inpCount.value; labCount.textContent = count; regenStars(); });
    inpDist.addEventListener('input', ()=>{ connectDist = +inpDist.value; labDist.textContent = connectDist; });
    inpGrad.addEventListener('change', ()=>{/* fond custom appliqu√© √† la vol√©e */});
    inpGrav.addEventListener('input', ()=>{ gravity = (+inpGrav.value)/100; labGrav.textContent = inpGrav.value; if (gravity>0) lastGravity = gravity; });

    // toggles
    chkAnim.addEventListener('change', ()=>{ animate = chkAnim.checked; byId('btn-toggle').textContent = animate ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Lire'; });
    chkTwink.addEventListener('change', ()=>{ twinkle = chkTwink.checked; });
    chkLabels.addEventListener('change', ()=>{ showLabels = chkLabels.checked; });
    chkErase.addEventListener('change', ()=>{ eraseMode = chkErase.checked; hoverSeg = null; });

    // palette
    selPalette.addEventListener('change', ()=>{
      currentPalette = selPalette.value;
      // on met √† jour le d√©grad√© pour correspondre √† la palette choisie
      inpGrad.value = palettes[currentPalette].grad;
    });

    // boutons
    byId('btn-toggle').addEventListener('click', ()=>{ animate = !animate; chkAnim.checked = animate; byId('btn-toggle').textContent = animate ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Lire'; });
    byId('btn-rand').addEventListener('click', ()=>{ seed = (Math.random()*1e9)>>>0; regenStars(); });
    byId('btn-reset').addEventListener('click', ()=>{
      seed = 42>>>0; count = 120; connectDist = 120; twinkle = true; animate = true; showLabels = false;
      currentPalette = 'nocturne'; selPalette.value = currentPalette; inpGrad.value = palettes[currentPalette].grad;
      gravity = 0; lastGravity = 0.5; inpGrav.value = 0; labGrav.textContent = '0';
      inpCount.value = count; labCount.textContent = count; inpDist.value = connectDist; labDist.textContent = connectDist;
      chkAnim.checked = true; chkTwink.checked = true; chkLabels.checked = false; chkErase.checked = false;
      blockedLinks.clear(); hoverSeg = null; eraseMode = false;
      regenStars();
    });
    byId('btn-export').addEventListener('click', ()=>{
      const a = document.createElement('a'); a.download = `constellation-${seed}.png`; a.href = canvas.toDataURL('image/png'); a.click();
    });
    byId('btn-full').addEventListener('click', ()=>{
      const el = document.documentElement;
      if (!document.fullscreenElement){ (wrap.requestFullscreen||el.requestFullscreen||function(){}).call(wrap); }
      else { document.exitFullscreen?.(); }
    });

    // Raccourcis : G bascule gravit√© (0 <-> derni√®re valeur), E bascule suppression
    window.addEventListener('keydown', (e)=>{
      if (e.key === 'g' || e.key === 'G'){
        if (gravity === 0){ gravity = lastGravity; inpGrav.value = Math.round(gravity*100); labGrav.textContent = inpGrav.value; }
        else { gravity = 0; inpGrav.value = 0; labGrav.textContent = '0'; }
      }
      if (e.key === 'e' || e.key === 'E'){
        eraseMode = !eraseMode; chkErase.checked = eraseMode; hoverSeg = null;
      }
    });

    // ---------- INIT ----------
    // palette par d√©faut
    document.getElementById('inp-grad').value = palettes[currentPalette].grad;
    regenStars();
    resize();
    cancelAnimationFrame(raf); last = performance.now(); raf = requestAnimationFrame(loop);
  })();
  </script>
</body>
</html>
